{% extends 'data/base.html' %}
{% block title %}CyberCarnage AI | ChatGPT Clone{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto mt-6 pb-10 px-4">

    <h2 class="text-5xl font-display font-black text-center text-transparent bg-clip-text
        bg-gradient-to-r from-pink-500 to-cyan-400 mb-8 glitch-hover">
        CYBER<span class="text-cyan-400">CARNAGE AI</span>
    </h2>

    <div id="chat-history"
         class="bg-[#0B0B0B]/80 border border-white/10 rounded-2xl shadow-2xl
                backdrop-blur-xl p-6 space-y-6 max-h-[70vh] overflow-y-auto">
    </div>

    <div id="typing" class="hidden mt-3 text-cyan-400 font-bold flex gap-3 items-center">
        <span class="loader border-t-2 border-b-2 border-cyan-400 w-5 h-5 rounded-full animate-spin"></span>
        Thinkingâ€¦
    </div>

    <div class="mt-6 bg-[#111]/60 border border-white/20 rounded-2xl p-4 relative">
        <textarea
            id="message"
            placeholder="Message CyberCarnage AI..."
            rows="1"
            class="w-full bg-transparent text-white resize-none outline-none font-mono"
        ></textarea>

        <button id="send-btn"
            class="absolute right-4 bottom-4 text-cyan-400 hover:text-cyan-200 transition">
            âž¤
        </button>
    </div>

</div>

<script>
const chatBox = document.getElementById("chat-history");
const msgInput = document.getElementById("message");
const sendBtn = document.getElementById("send-btn");
const typing = document.getElementById("typing");

let editingMsg = null;
let currentTypingInterval = null;

// Save to Local Storage
function saveMessage(type, text) {
    const history = JSON.parse(localStorage.getItem('chat_history') || '[]');
    history.push({ type, text });
    localStorage.setItem('chat_history', JSON.stringify(history));
}

// Auto-grow textarea
msgInput.addEventListener("input", () => {
    msgInput.style.height = "auto";
    msgInput.style.height = msgInput.scrollHeight + "px";
});

// Typewriter effect
function typeWriter(el, text, speed=14) {
    let i = 0;
    return new Promise((resolve) => {
        currentTypingInterval = setInterval(() => {
            if(i < text.length){
                el.innerHTML += text.charAt(i);
                i++;
                chatBox.scrollTop = chatBox.scrollHeight;
            } else {
                clearInterval(currentTypingInterval);
                currentTypingInterval = null;
                resolve();
            }
        }, speed);
    });
}

// Add User Message
function addUserMessage(text, save=true) {
    const div = document.createElement("div");
    div.className = "flex items-start gap-3 justify-end animate-slide-in";

    div.innerHTML = `
        <div class="bg-cyan-400 text-black p-4 rounded-2xl max-w-[75%] shadow-lg font-mono">${text}</div>
        <img src="/static/img/user.png" class="w-10 h-10 rounded-lg">
        <div class="flex gap-2 mt-1">
            <button class="edit-btn text-xs underline text-yellow-300">Edit</button>
        </div>
    `;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;

    div.querySelector(".edit-btn").onclick = () => {
        msgInput.value = text;
        msgInput.focus();
        editingMsg = div.querySelector("div");
        msgInput.style.height = msgInput.scrollHeight + "px";
    };

    if(save) saveMessage("user", text);
}

// Bind alerts for AI messages
function bindCopyShareButtonsAI(container, text) {
    const copyBtn = container.querySelector(".copy-btn");
    const shareBtn = container.querySelector(".share-btn");

    if(copyBtn){
        copyBtn.onclick = () => navigator.clipboard.writeText(text)
            .then(() => alert("âœ… Copied to clipboard!"));
    }

    if(shareBtn){
        shareBtn.onclick = () => navigator.clipboard.writeText(`CyberCarnage AI Response:\n\n${text}`)
            .then(() => alert("ðŸ”— Share text copied!"));
    }
}

// Add AI Message
async function addAIMessage(text, save=true, instant=false) {
    const wrap = document.createElement("div");
    wrap.className = "flex items-start gap-3 animate-slide-in";

    wrap.innerHTML = `
        <img src="/static/img/ai.png" class="w-10 h-10 rounded-lg opacity-70">
        <div class="bg-white/5 p-4 rounded-2xl border border-white/10 text-gray-200 max-w-[80%]">
            <div class="ai-text"></div>
            <div class="flex gap-4 mt-2 text-xs">
                <button class="copy-btn text-cyan-300 underline">Copy</button>
                <button class="share-btn text-purple-300 underline">Share</button>
            </div>
        </div>
    `;
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;

    const textDiv = wrap.querySelector(".ai-text");

    if(instant){
        textDiv.innerHTML = text;
    } else {
        await typeWriter(textDiv, text);
    }

    // Bind alert buttons for AI message
    bindCopyShareButtonsAI(wrap, text);

    if(save) saveMessage("ai", text);
}

// Send Message
async function sendMessage() {
    const msg = msgInput.value.trim();
    if(!msg) return;

    if(editingMsg){
        editingMsg.innerText = msg;
        editingMsg = null;
        msgInput.value = "";
        msgInput.style.height = "auto";
        return;
    }

    addUserMessage(msg);
    msgInput.value = "";
    msgInput.style.height = "auto";
    typing.classList.remove("hidden");

    sendBtn.innerText = "â– ";
    sendBtn.classList.add("text-red-500");

    let stopTyping = false;
    sendBtn.onclick = () => {
        if(currentTypingInterval){
            clearInterval(currentTypingInterval);
            currentTypingInterval = null;
        }
        stopTyping = true;
        typing.classList.add("hidden");
        sendBtn.innerText = "âž¤";
        sendBtn.classList.remove("text-red-500");
        sendBtn.onclick = sendMessage;
    };

    try{
        const res = await fetch("{% url 'AI_chat' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: `message=${encodeURIComponent(msg)}`
        });
        const data = await res.json();

        if(!stopTyping){
            await addAIMessage(data.response, true, false);
        }

    }catch(error){
        console.error("âŒ Something went wrong!", error);
    }finally{
        typing.classList.add("hidden");
        if(currentTypingInterval){
            clearInterval(currentTypingInterval);
            currentTypingInterval = null;
        }
        sendBtn.innerText = "âž¤";
        sendBtn.classList.remove("text-red-500");
        sendBtn.onclick = sendMessage;
    }
}

// Button & Enter key
sendBtn.onclick = sendMessage;
msgInput.addEventListener("keypress", e => {
    if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
    }
});

// Load History
window.onload = () => {
    const history = JSON.parse(localStorage.getItem("chat_history") || "[]");

    if(history.length === 0){
        addAIMessage("ðŸ‘‹ Welcome! Ask me anything.", false, false);
    }

    history.forEach(msg => {
        if(msg.type === "user") addUserMessage(msg.text, false);
        else addAIMessage(msg.text, false, true);
    });
};
</script>

<style>
#chat-history::-webkit-scrollbar { width: 7px; }
#chat-history::-webkit-scrollbar-thumb { background: #00f3ff; border-radius: 4px; }

@keyframes slideIn { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }
.animate-slide-in { animation: slideIn .45s ease; }
</style>

{% endblock %}
