{% extends 'data/base.html' %}
{% block title %}CyberCarnage AI | ChatGPT Clone{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-6 pb-10 px-4">

    <h2 class="text-5xl font-display font-black text-center text-transparent bg-clip-text
        bg-gradient-to-r from-pink-500 to-cyan-400 mb-8 glitch-hover">
        CYBER<span class="text-cyan-400">CARNAGE AI</span>
    </h2>

    <div id="chat-history"
         class="bg-[#0B0B0B]/80 border border-white/10 rounded-2xl shadow-2xl
                backdrop-blur-xl p-6 space-y-6 max-h-[70vh] overflow-y-auto touch-auto">
    </div>

    <div id="typing" class="hidden mt-3 text-cyan-400 font-bold flex gap-3 items-center">
        <span class="loader border-t-2 border-b-2 border-cyan-400 w-5 h-5 rounded-full animate-spin"></span>
        Thinking‚Ä¶
    </div>

    <div class="mt-6 bg-[#111]/60 border border-white/20 rounded-2xl p-4 relative">
        <textarea
            id="message"
            placeholder="Message CyberCarnage AI..."
            rows="1"
            class="w-full bg-transparent text-white resize-none outline-none font-mono"
        ></textarea>

        <button id="send-btn"
            class="absolute right-4 bottom-4 text-cyan-400 hover:text-cyan-200 transition">
            ‚û§
        </button>
    </div>

</div>

<script>
const chatBox = document.getElementById("chat-history");
const msgInput = document.getElementById("message");
const sendBtn = document.getElementById("send-btn");
const typing = document.getElementById("typing");

let currentTypingInterval = null;

// Generate Guest ID for anonymous user
let guestId = localStorage.getItem("guest_id");
if (!guestId) {
    guestId = crypto.randomUUID();
    localStorage.setItem("guest_id", guestId);
}

// Auto-grow textarea
msgInput.addEventListener("input", () => {
    msgInput.style.height = "auto";
    msgInput.style.height = msgInput.scrollHeight + "px";
});

// Typewriter effect
function typeWriter(el, text, speed=14) {
    let i = 0;
    return new Promise((resolve) => {
        currentTypingInterval = setInterval(() => {
            if(i < text.length){
                el.innerHTML += text.charAt(i);
                i++;
                chatBox.scrollTop = chatBox.scrollHeight;
            } else {
                clearInterval(currentTypingInterval);
                currentTypingInterval = null;
                resolve();
            }
        }, speed);
    });
}

// Add User Message
function addUserMessage(text) {
    const div = document.createElement("div");
    div.className = "flex items-start gap-3 justify-end animate-slide-in";
    div.innerHTML = `
        <div class="bg-cyan-400 text-black p-4 rounded-2xl max-w-[75%] shadow-lg font-mono">${text}</div>
        <img src="/static/img/user.png" class="w-10 h-10 rounded-lg">
    `;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Add AI Message
async function addAIMessage(text) {
    const wrap = document.createElement("div");
    wrap.className = "flex items-start gap-3 animate-slide-in";
    wrap.innerHTML = `
        <img src="/static/img/ai.png" class="w-10 h-10 rounded-lg opacity-70">
        <div class="bg-white/5 p-4 rounded-2xl border border-white/10 text-gray-200 max-w-[80%]">
            <div class="ai-text"></div>
            <div class="flex gap-4 mt-2 text-xs">
                <button class="copy-btn text-cyan-300 underline">Copy</button>
                <button class="share-btn text-purple-300 underline">Share</button>
            </div>
        </div>
    `;
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;

    const textDiv = wrap.querySelector(".ai-text");
    await typeWriter(textDiv, text);

    wrap.querySelector(".copy-btn").onclick = () => navigator.clipboard.writeText(text)
        .then(() => alert("‚úÖ Copied to clipboard!"));
    wrap.querySelector(".share-btn").onclick = () => navigator.clipboard.writeText(`CyberCarnage AI Response:\n\n${text}`)
        .then(() => alert("üîó Share text copied!"));
}

// Send Message
async function sendMessage() {
    const msg = msgInput.value.trim();
    if(!msg) return;

    addUserMessage(msg);
    msgInput.value = "";
    msgInput.style.height = "auto";
    typing.classList.remove("hidden");

    sendBtn.innerText = "‚ñ†";
    sendBtn.classList.add("text-red-500");

    try{
        const res = await fetch("{% url 'AI_chat' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
                "X-GUEST-ID": guestId
            },
            body: JSON.stringify({message: msg})
        });

        const data = await res.json();

        if(data.error){
            await addAIMessage(data.error);
        } else {
            await addAIMessage(data.response);
        }

    }catch(error){
        console.error("‚ùå Something went wrong!", error);
        await addAIMessage("‚ùå AI service unavailable. Try again.");
    } finally {
        typing.classList.add("hidden");
        sendBtn.innerText = "‚û§";
        sendBtn.classList.remove("text-red-500");
    }
}

sendBtn.onclick = sendMessage;
msgInput.addEventListener("keypress", e => {
    if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
    }
});

// Load history from backend
async function loadHistory() {
    try {
        const res = await fetch("{% url 'chat_history' %}", {
            method: "GET",
            headers: {"X-GUEST-ID": guestId}
        });
        const data = await res.json();

        if(data.messages.length === 0){
            // First-time user ‚Üí show welcome message
            await addAIMessage("üëã Welcome to CyberCarnage AI! Ask me anything.");
        } else {
            // Display messages in order
            for(const msg of data.messages){
                if(msg.role === "user") addUserMessage(msg.message);
                else await addAIMessage(msg.message);
            }
        }

        // Scroll to bottom after loading
        chatBox.scrollTop = chatBox.scrollHeight;

    } catch(e) {
        console.error("Error loading chat history", e);
        await addAIMessage("‚ùå Failed to load chat history.");
    }
}

window.onload = loadHistory;
</script>

<style>
#chat-history::-webkit-scrollbar { width: 7px; }
#chat-history::-webkit-scrollbar-thumb { background: #00f3ff; border-radius: 4px; }
.touch-auto { touch-action: pan-y; }

@keyframes slideIn { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }
.animate-slide-in { animation: slideIn .45s ease; }
</style>

{% endblock %}
