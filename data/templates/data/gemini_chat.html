{% extends 'data/base.html' %}
{% load static %}
{% block title %}CyberCarnage AI{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-6 pb-10 px-4">
    <link rel="manifest" href="{% static 'icons/site.webmanifest' %}">

    <h2 class="text-5xl font-display font-black text-center text-transparent bg-clip-text
        bg-gradient-to-r from-pink-500 to-cyan-400 mb-8 glitch-hover">
        CYBER<span class="text-cyan-400">CARNAGE AI</span>
    </h2>

    <div id="chat-history"
         class="bg-[#0B0B0B]/80 border border-white/10 rounded-2xl shadow-2xl
                backdrop-blur-xl p-6 space-y-6 max-h-[70vh] overflow-y-auto touch-auto">
    </div>

    <div id="typing" class="hidden mt-3 text-cyan-400 font-bold flex gap-3 items-center">
        <span class="loader border-t-2 border-b-2 border-cyan-400 w-5 h-5 rounded-full animate-spin"></span>
        Thinking‚Ä¶
    </div>

    <div class="mt-6 bg-[#111]/60 border border-white/20 rounded-2xl p-4 relative">
        <textarea id="message" placeholder="Message CyberCarnage AI..." rows="1"
                  class="w-full bg-transparent text-white resize-none outline-none font-mono"></textarea>

        <button id="send-btn" class="absolute right-1 bottom-2 text-cyan-400 hover:text-cyan-200 transition text-3xl font-bold">
            ‚û§
        </button>
    </div>
</div>

<script>
const AI_AVATAR = "{% static 'img/ai.png' %}";
const USER_AVATAR = "{% static 'img/user.png' %}";

const chatBox = document.getElementById("chat-history");
const msgInput = document.getElementById("message");
const sendBtn = document.getElementById("send-btn");
const typing = document.getElementById("typing");

let guestId;
try {
    guestId = localStorage.getItem("guest_id");
    if (!guestId) { guestId = crypto.randomUUID(); localStorage.setItem("guest_id", guestId); }
} catch { guestId = crypto.randomUUID(); }

msgInput.addEventListener("input", () => {
    msgInput.style.height = "auto";
    msgInput.style.height = msgInput.scrollHeight + "px";
});

// Typewriter Effect
function typeWriter(el, text, speed=12){
    let i=0;
    return new Promise(resolve=>{
        const interval=setInterval(()=>{
            if(i<text.length){ el.innerHTML += text.charAt(i++); chatBox.scrollTop = chatBox.scrollHeight; }
            else{ clearInterval(interval); resolve(); }
        }, speed);
    });
}

function addUserMessage(text){
    const div=document.createElement("div");
    div.className="flex items-start gap-3 justify-end animate-slide-in";
    div.innerHTML=`<div class="bg-cyan-400 text-black p-4 rounded-2xl max-w-[75%] shadow-lg font-mono">${text}</div>
                   <img src="${USER_AVATAR}" class="w-10 h-10 rounded-lg">`;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
}

async function addAIMessage(text){
    const wrap=document.createElement("div");
    wrap.className="flex items-start gap-3 animate-slide-in";
    wrap.innerHTML=`<img src="${AI_AVATAR}" class="w-10 h-10 rounded-lg opacity-70">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/10 text-gray-200 max-w-[80%]">
                        <div class="ai-text"></div>
                        <div class="flex gap-4 mt-2 text-xs">
                            <button class="copy-btn text-cyan-300 underline">Copy</button>
                            <button class="share-btn text-purple-300 underline">Share</button>
                        </div>
                    </div>`;
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;

    const textDiv=wrap.querySelector(".ai-text");
    await typeWriter(textDiv, text);

    wrap.querySelector(".copy-btn").onclick = ()=> navigator.clipboard.writeText(text);
    wrap.querySelector(".share-btn").onclick = ()=> navigator.clipboard.writeText(`CyberCarnage AI Response:\n\n${text}`);
}

let aiTyping = false;
async function sendMessage(){
    const msg=msgInput.value.trim();
    if(!msg) return;

    addUserMessage(msg);
    msgInput.value="";
    typing.classList.remove("hidden");

    sendBtn.innerText = "‚èπ";  // Stop icon
    aiTyping = true;

    try{
        const res=await fetch("{% url 'api_ai_chat' %}", {
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken":"{{ csrf_token }}",
                "X-GUEST-ID": guestId
            },
            body: JSON.stringify({message:msg})
        });
        const data=await res.json();
        if(!res.ok) await addAIMessage(data.error||`‚ùå Error ${res.status}`);
        else await addAIMessage(data.response);
    }catch(e){ console.error(e); await addAIMessage("‚ùå Backend unreachable"); }
    finally{
        typing.classList.add("hidden");
        aiTyping=false;
        sendBtn.innerText = "‚û§"; // Back to send
    }
}

sendBtn.onclick = ()=> {
    if(aiTyping){
        aiTyping=false;
        sendBtn.innerText = "‚û§"; // revert
        typing.classList.add("hidden");
    } else sendMessage();
};

msgInput.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});

async function loadHistory(){
    try{
        const res=await fetch("{% url 'chat_history' %}", { headers: {"X-GUEST-ID": guestId} });
        const data=await res.json();
        if(data.messages.length===0) await addAIMessage("üëã Welcome! Ask me anything.");
        else for(const msg of data.messages){ msg.role==="user"?addUserMessage(msg.message):await addAIMessage(msg.message); }
    }catch(e){ await addAIMessage("‚ùå Failed to load history"); }
}

window.onload=loadHistory;
</script>

<style>
#chat-history::-webkit-scrollbar { width: 7px; }
#chat-history::-webkit-scrollbar-thumb { background: #00f3ff; border-radius: 4px; }

@keyframes slideIn { from { opacity:0; transform:translateY(25px); } to { opacity:1; transform:translateY(0); } }
.animate-slide-in { animation: slideIn .45s ease; }

#send-btn { font-size: 2rem; padding: 0.25rem 0.5rem; }
</style>

{% endblock %}
