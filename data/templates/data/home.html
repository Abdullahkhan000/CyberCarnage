{% extends "data/base.html" %}

{% block title %}
CYBERCARNAGE | MAIN CATALOGUE
{% endblock %}

{% block content %}
<style>
@keyframes slideInUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
.card-entry { animation: slideInUp 0.6s ease-out forwards; }

@keyframes borderPulse {
  0% { border-color: rgba(236,72,153,0.5); box-shadow: 0 0 10px rgba(236,72,153,0.4); }
  50% { border-color: rgba(255,255,255,0.8); box-shadow: 0 0 25px rgba(255,255,255,0.7); }
  100% { border-color: rgba(236,72,153,0.5); box-shadow: 0 0 10px rgba(236,72,153,0.4); }
}
.group:hover .pulsing-border { animation: borderPulse 0.5s infinite alternate; }

@keyframes dynamicPan { 0% { transform: scale(1.1) translateX(0); } 50% { transform: scale(1.05) translateX(-5%); } 100% { transform: scale(1.1) translateX(0); } }
.poster-move { animation: dynamicPan 20s linear infinite alternate; transform-origin: top left; }

select { background-color: rgba(0,0,0,0.7); color: white; appearance: none; cursor: pointer; }
select option { background-color: rgba(0,0,0,0.85); color: white; }

.page-btn { transition: all 0.3s; }
.page-btn:hover { transform: scale(1.05); }
.page-btn.active { background-color: #ec4899; color: white; }
.dots { color: #aaa; }
</style>

<div class="relative z-10 container mx-auto px-4 py-12">

  <div class="text-center mb-16 border-b-2 border-cyan-500/30 pb-8">
    <h1 class="text-4xl sm:text-5xl md:text-8xl font-display font-black uppercase tracking-tight
               text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500
               drop-shadow-[0_0_10px_rgba(236,72,153,0.5)] glitch-hover mb-4 break-words">
      MAIN CATALOGUE
    </h1>
    <p class="text-gray-400 mt-2 text-lg font-mono tracking-wide mb-6 break-words">
      Explore all <span class="text-pink-400">>> {{ all_games.count }}</span> games in our records.
    </p>
    <a href="{% url 'AI_chat' %}" class="inline-block bg-cyan-400 hover:bg-cyan-500 text-black font-bold
               px-6 py-3 rounded-lg glitch-hover transition text-lg">
      ASK CYBERCARNAGE AI FOR GAME INFO
    </a>
  </div>

  <!-- Filters -->
  <div class="mb-4 p-6 bg-black/70 rounded-2xl border border-cyan-500/40 backdrop-blur-md
              grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 max-w-5xl mx-auto">

    <input type="text" id="filter-game-name" placeholder="Game Name" class="px-4 py-3 bg-black/70 border border-cyan-400 rounded-xl text-white font-bold tracking-wide text-lg uppercase placeholder:text-cyan-300 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-1 transition-all w-full">

    <div class="relative w-full group">
      <select id="filter-series" class="w-full px-4 py-3 bg-gradient-to-r from-purple-500/30 to-pink-500/30 border border-cyan-400 rounded-xl text-white font-bold tracking-wide text-lg uppercase focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-1 transition-all pr-10">
        <option value="">All Series</option>
        {% for game in all_games %}
          {% if game.series %}
            <option value="{{ game.series }}">{{ game.series }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <div class="relative w-full group">
      <select id="filter-company" class="w-full px-4 py-3 bg-gradient-to-r from-pink-500/30 to-purple-500/30 border border-cyan-400 rounded-xl text-white font-bold tracking-wide text-lg uppercase focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-1 transition-all pr-10">
        <option value="">All Developers</option>
        {% for game in all_games %}
          {% if game.developer %}
            <option value="{{ game.developer }}">{{ game.developer }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <div class="relative w-full group">
      <select id="filter-platform" class="w-full px-4 py-3 bg-gradient-to-r from-purple-500/30 to-pink-500/30 border border-cyan-400 rounded-xl text-white font-bold tracking-wide text-lg uppercase focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-1 transition-all pr-10">
        <option value="">All Platforms</option>
        {% for game in all_games %}
          {% with detail=game.details.first %}
            {% if detail and detail.platform %}
              <option value="{{ detail.platform }}">{{ detail.platform }}</option>
            {% endif %}
          {% endwith %}
        {% endfor %}
      </select>
    </div>

    <div class="relative w-full group">
      <select id="filter-year" class="w-full px-4 py-3 bg-gradient-to-r from-purple-500/30 to-pink-500/30 border border-cyan-400 rounded-xl text-white font-bold tracking-wide text-lg uppercase focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-1 transition-all pr-10">
        <option value="">All Years</option>
        {% for game in all_games %}
          {% if game.release_date %}
            <option value="{{ game.release_date|date:'Y' }}">{{ game.release_date|date:'Y' }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </div>

    <input type="text" id="filter-steam-appid" placeholder="Steam AppID" class="px-4 py-3 bg-black/70 border border-cyan-400 rounded-xl text-white font-bold tracking-wide text-lg uppercase placeholder:text-cyan-300 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-1 transition-all w-full">

    <button id="clear-filters" class="col-span-full bg-gradient-to-r from-cyan-400 to-cyan-600 hover:from-cyan-500 hover:to-cyan-700 text-black font-bold px-6 py-3 rounded-2xl uppercase tracking-wider text-lg shadow-lg transition-all">
      Clear Filters
    </button>
  </div>

  <div id="active-filters" class="mb-6 max-w-5xl mx-auto flex flex-wrap gap-2"></div>

  <div id="no-results" class="col-span-full flex flex-col items-center justify-center py-20 text-center text-gray-500 hidden">
    <div class="text-6xl mb-4 text-red-500 animate-pulse-slow">ðŸ›‘</div>
    <h3 class="text-2xl font-display font-bold">NO MATCHING RESULTS FOUND</h3>
    <p class="text-gray-600 font-mono mt-2">TRY ADJUSTING OR CLEARING THE FILTERS.</p>
  </div>

  <!-- Cards -->
<div id="cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
  {% for game in all_games %}
    {% with detail=game.details.first %}
      <div class="group relative bg-cyber-gray/60 backdrop-blur-md rounded-xl border border-gray-700/50
                  overflow-hidden hover:-translate-y-2 hover:shadow-[0_0_30px_rgba(236,72,153,0.4)]
                  transition-all duration-500 ease-out cursor-pointer card-entry"
           style="animation-delay: {{ forloop.counter }}00ms; opacity: 0;"
           data-game-name="{{ game.game_name|lower }}"
           data-series="{{ game.series|default_if_none:''|lower }}"
           data-company="{{ game.developer|lower }}"
           data-platform="{{ detail.platform|default_if_none:''|lower }}"
           data-year="{{ game.release_date|date:'Y' }}"
           data-steam-appid="{{ detail.steam_appid|default_if_none:'' }}">

        {% if detail %}
          <a href="{% url 'game_detail' detail.id detail.game.slug %}" class="absolute inset-0 z-30"></a>
        {% else %}
          <a class="absolute inset-0 z-30 cursor-not-allowed opacity-30" title="Details not added yet"></a>
        {% endif %}

        <div class="absolute inset-0 rounded-xl border-2 border-transparent group-hover:border-pink-500/50 transition-colors duration-300 pointer-events-none z-20 pulsing-border"></div>

        <div class="relative h-56 overflow-hidden">
          <div class="absolute inset-0 bg-gradient-to-t from-cyber-gray/90 via-transparent to-transparent z-10 opacity-80"></div>
          {% if detail and detail.poster %}
            <img src="{{ detail.poster }}" alt="{{ game.game_name }}" class="w-full h-full object-cover poster-move transition-transform duration-700 ease-in-out">
          {% else %}
            <div class="w-full h-full bg-gray-800 flex items-center justify-center text-gray-500 font-mono">NO POSTER</div>
          {% endif %}
          {% if game.series %}
            <span class="absolute top-3 left-3 z-20 bg-black/70 backdrop-blur-sm border border-purple-500/50 text-purple-400 text-xs font-mono uppercase px-3 py-1 rounded-full shadow-lg">
              Series: {{ game.series }}
            </span>
          {% endif %}
        </div>

        <div class="p-5 relative z-20 -mt-10">
          <h3 class="text-2xl font-display font-bold text-white leading-tight drop-shadow-lg group-hover:text-pink-300 transition-colors animate-float">
            {{ game.game_name }}
          </h3>

          <div class="h-px w-full bg-gradient-to-r from-gray-700 via-gray-500 to-gray-700 my-4 opacity-50"></div>

          <div class="space-y-2 text-sm font-mono">
            <p class="flex justify-between items-center text-gray-400">
              <span class="text-xs uppercase tracking-wider">DEV. UNIT:</span>
              <span class="text-cyan-400 font-semibold">{{ game.developer }}</span>
            </p>
            <p class="flex justify-between items-center text-gray-400">
              <span class="text-xs uppercase tracking-wider">INIT. DATE:</span>
              <span class="text-purple-400 font-semibold">{{ game.release_date }}</span>
            </p>
            <p class="flex justify-between items-center text-gray-400">
              <span class="text-xs uppercase tracking-wider">STEAM ID:</span>
              <span class="text-green-400 font-semibold ml-10">{{ detail.steam_appid }}</span>
            </p>
          </div>

          <div class="text-center mt-6">
            {% if detail %}
              <a href="{% url 'game_detail' detail.id detail.game.slug %}">
                <span class="relative inline-block text-sm font-bold text-pink-500 border-b border-pink-500 opacity-80 group-hover:opacity-100 group-hover:text-white group-hover:border-white transition-all duration-300 glitch-hover">
                  [ VIEW DATA FILE ]
                </span>
              </a>
            {% else %}
              <span class="relative inline-block text-sm font-bold text-gray-600 border-b border-gray-600 opacity-50 cursor-not-allowed" title="Details not added yet">
                [ NO DATA FILE ]
              </span>
            {% endif %}
          </div>
        </div>
      </div>
    {% endwith %}
  {% endfor %}
</div>

</div>

{% with current_params=request.GET.urlencode %}
<div id="pagination-container" class="mt-10 flex justify-center items-center space-x-2">

    {% if page_obj.has_previous %}
        <a class="page-btn px-4 py-2 bg-cyan-400 hover:bg-cyan-500 text-black rounded-lg font-bold"
           href="?{% if current_params %}{{ current_params }}&{% endif %}page={{ page_obj.previous_page_number }}">Â« Prev</a>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
            <span class="page-btn px-4 py-2 bg-pink-500 text-white rounded-lg font-bold">{{ num }}</span>
        {% else %}
            <a class="page-btn px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg font-bold"
               href="?{% if current_params %}{{ current_params }}&{% endif %}page={{ num }}">{{ num }}</a>
        {% endif %}
    {% endfor %}

    {% if page_obj.has_next %}
        <a class="page-btn px-4 py-2 bg-cyan-400 hover:bg-cyan-500 text-black rounded-lg font-bold"
           href="?{% if current_params %}{{ current_params }}&{% endif %}page={{ page_obj.next_page_number }}">Next Â»</a>
    {% endif %}

</div>
{% endwith %}


<!-- ===== JS Filters + Pagination ===== -->
<script>
(function() {

  const filters = {
    gameName: document.getElementById('filter-game-name'),
    series: document.getElementById('filter-series'),
    company: document.getElementById('filter-company'),
    platform: document.getElementById('filter-platform'),
    year: document.getElementById('filter-year'),
    steamAppid: document.getElementById('filter-steam-appid'),
  };

  const clearBtn = document.getElementById('clear-filters');
  const cards = Array.from(document.querySelectorAll('.card-entry'));
  const noResults = document.getElementById('no-results');

  const ITEMS_PER_PAGE = 8;
  let currentPage = 1;

  /* ================= URL HELPERS ================= */
  function getParams() {
    return new URLSearchParams(window.location.search);
  }

  function setURL(values, page = 1) {
  const params = new URLSearchParams(window.location.search);

  // Remove old 'page' param
  params.delete('page');

  // Add filter values
  Object.entries(values).forEach(([key, val]) => {
    if (val) params.set(key, val);
  });

  // Add new page value
  params.set('page', page);

  // Update the URL
  history.replaceState({}, '', '?' + params.toString());
}

  function readURL() {
    const params = getParams();
    Object.keys(filters).forEach(key => {
      if (filters[key] && params.get(key)) {
        filters[key].value = params.get(key);
      }
    });
    currentPage = parseInt(params.get('page')) || 1;
  }

  /* ================= FILTER LOGIC ================= */
  function val(el) {
    return el ? el.value.toLowerCase().trim() : '';
  }

  function data(card, key) {
    return card.dataset[key] ? card.dataset[key].toLowerCase() : '';
  }

  function applyFilters() {
    const values = {
      gameName: val(filters.gameName),
      series: val(filters.series),
      company: val(filters.company),
      platform: val(filters.platform),
      year: val(filters.year),
      steamAppid: val(filters.steamAppid),
    };

    // Filter cards
    const filtered = cards.filter(card => {
      return data(card, 'gameName').includes(values.gameName) &&
             data(card, 'series').includes(values.series) &&
             data(card, 'company').includes(values.company) &&
             data(card, 'platform').includes(values.platform) &&
             (values.year === '' || data(card, 'year') === values.year) &&
             data(card, 'steamAppid').includes(values.steamAppid);
    });

    // Show "no results" if empty
    noResults.classList.toggle('hidden', filtered.length > 0);

    // Paginate filtered cards
    const totalPages = Math.ceil(filtered.length / ITEMS_PER_PAGE);
    if (currentPage > totalPages) currentPage = 1;

    cards.forEach(card => card.style.display = 'none'); // hide all
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    filtered.slice(start, end).forEach(card => card.style.display = '');

    // Update URL (page + filters)
    setURL(values, currentPage);
  }

  /* ================= EVENTS ================= */
  Object.values(filters).forEach(input => {
    if (!input) return;
    input.addEventListener('input', () => { currentPage = 1; applyFilters(); });
    input.addEventListener('change', () => { currentPage = 1; applyFilters(); });
  });

  if (clearBtn) {
  clearBtn.addEventListener('click', () => {
    // Clear all filter inputs
    Object.values(filters).forEach(input => { if(input) input.value = ''; });
    currentPage = 1;

    // Apply filters (show all cards)
    applyFilters();

    // Clear all filter params from URL
    const params = new URLSearchParams(window.location.search);
    Object.keys(filters).forEach(key => params.delete(key)); // remove filter keys
    params.delete('page'); // also remove page key
    history.replaceState({}, '', '?' + params.toString());
  });
  }

  /* ================= INIT ================= */
  readURL();
  applyFilters();

})();
</script>

{% endblock %}
